name: Release & Publish

on:
  push:
    tags:
      - 'v*.*.*' # Déclenché sur les tags de version (ex: v1.0.0)

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%h)" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          release_name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Changes in ${{ steps.version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Features
            - 23 use cases (Player, Team, Game, Stats)
            - 24 REST API endpoints
            - 246 tests passing
            - Clean Architecture
            - Docker support (Production + Development)
            - MongoDB integration

            ## Documentation
            - [API Documentation](./backend/docs/API.md)
            - [Architecture](./backend/docs/ARCHITECTURE.md)
            - [Use Cases](./backend/docs/USE_CASES.md)
          draft: false
          prerelease: false

  publish-docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    needs: [create-release]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push production image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/statcoach-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/statcoach-backend:${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push development image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.dev
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/statcoach-backend:dev
            ${{ secrets.DOCKERHUB_USERNAME }}/statcoach-backend:dev-${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # publish-npm:
  #   name: Publish to GitHub Packages (Optional)
  #   runs-on: ubuntu-latest
  #   needs: [create-release]
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   permissions:
  #     contents: read
  #     packages: write

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         registry-url: 'https://npm.pkg.github.com'
  #         scope: '@${{ github.repository_owner }}'

  #     - name: Install dependencies
  #       working-directory: ./backend
  #       run: npm ci

  #     - name: Build
  #       working-directory: ./backend
  #       run: npm run build

  # Décommenter pour publier sur GitHub Packages
  # - name: Publish to GitHub Packages
  #   working-directory: ./backend
  #   run: npm publish
  #   env:
  #     NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
